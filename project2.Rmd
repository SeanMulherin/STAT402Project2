---
title: "Analyzing The Influence of Biological Factors vs. Lifestyle Habits on Stroke Victims"
author: "Group 4"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: html_document
---

Biological Factors

| | |
| --- | --- |
| gender | categorical |
| age | numeric |
| hypertension | categorical |
| heart_disease | categorical |
| avg_glucose_level |
| bmi | categorical |


Lifestyle Habits:

- ever_married
- work_type
- Residence_type
- smoking_status 

```{r setup, include=F}
set.seed(10);

library(ggplot2);
library(dplyr);
library(knitr);
library(car);
library(ROCR);
library(corrplot); #correlation heat map
```

```{r colors, include=F}
UCLA_colors <- list(
    ucla_blue = '#2774AE',
    ucla_gold = '#FFD100',
    darkest_blue = '#003B5C',
    darker_blue = '#005587',
    lighter_blue = '#8BB8E8',
    lightest_blue = '#DAEBFE',
    darkest_gold = '#FFB81C',
    darker_gold = '#FFC72C'
);
```


```{r data-prep, include=F}
load_stroke_data <- function(path) {
    read.csv(path, header = T, na.strings = "N/A");
}

prep_stroke_data <- function(stroke_data) {
    stroke_data <- na.omit(stroke_data);
    stroke_data <- stroke_data[-which(stroke_data$gender == "Other"), ];
    stroke_data$smoking_status <- factor(
        stroke_data$smoking_status,
        levels = c(
            'never smoked',
            'formerly smoked',
            'smokes'
        )
    );
    stroke_data$work_type <- factor(
        stroke_data$work_type,
        levels = c(
            'Never_worked',
            'Private',
            'Self-employed',
            'Govt_job',
            'children'
        )
    );
    
    return(stroke_data);
}

split_stroke_data <- function(stroke_data, training_proportion) {
    n <- nrow(stroke_data);
    num_training <- n * training_proportion;
    training_i <- sample.int(n, num_training);
    
    list(
        training = stroke_data[training_i, ],
        test = stroke_data[-training_i, ]
    );
}

stroke <- load_stroke_data("healthcare-dataset-stroke-data.csv") |> 
    prep_stroke_data() |> 
    split_stroke_data(training_proportion = 0.8);
```

## EDA
```{r eda, echo=F}
####### Normality #######
histo_plots <- function() {
  ggplot(stroke$training) +
    geom_bar(mapping = aes(x = age), width = 2) + theme_classic() + ggtitle("Age");
    
  ggplot(stroke$training) +
    geom_bar(mapping = aes(x = avg_glucose_level), width = .001) + theme_classic() + ggtitle("Glucose Level");
  ggplot(stroke$training) +
    geom_bar(mapping = aes(x = bmi), width = 10) + theme_classic() + ggtitle("BMI");
}

# transform avg_glucose_level because it's right skewed
symbox_plot <- symbox(~avg_glucose_level, data = stroke$training)
stroke$training$avg_glucose_level <- stroke$training$avg_glucose_level^(-1)

####### Correlation #######
# we should do this for all variables by converting to dummy, I selected only numeric ones for now
correlation_values <- stroke$training |> select("age", "hypertension", "heart_disease", "avg_glucose_level", "bmi") |> cor() 
corr_plot <- corrplot.mixed(correlation_values,
                 lower = "number", upper = "circle", tl.pos = "l", diag = "l",
                 main = "Correlation Matrix")

####### Equality of Variance #######
homoscedasticity_test <- function(pred){
  p <- bartlett.test(stroke ~ pred, data = stroke$training)$p.value
  if(p > 0.05) {return("Assumption of Equality of Variance Failed")}
  else {return("Assumption of Equality of Variance Holds")}
}
#homoscedasticity_test(stroke$training$ever_married)
#homoscedasticity_test(stroke$training$work_type)
#homoscedasticity_test(stroke$training$Residence_type) # fails equality of variance
#homoscedasticity_test(stroke$training$smoking_status)
#homoscedasticity_test(stroke$training$hypertension)
#homoscedasticity_test(stroke$training$heart_disease)
#homoscedasticity_test(stroke$training$gender) # fails equality of variance

####### Collinearity #######
logreg <- glm(stroke ~., data = stroke$training, family = "binomial") ## log reg model
vif(logreg)
```

### Age Groups

```{r age-groups, echo=F}
group_ages <- function(stroke_data, breaks) {
    stroke_data$age_group <- factor(cut(stroke_data$age, breaks = breaks));
    return(stroke_data);
}

age_breaks <- c(0, 40, 60, 85);
stroke$training <- group_ages(stroke$training, breaks = age_breaks);
stroke$test <- group_ages(stroke$test, breaks = age_breaks);
```

## Variable and Model Selection
```{r model, echo=F}
log_all <- glm(stroke ~ ., data = stroke$training, family = "binomial")
log_sig <- glm(stroke ~ age + hypertension + heart_disease + avg_glucose_level + smoking_status, 
              data = stroke$training, family = "binomial") # only significant variables

# Compare models
anova_summary <- anova(log_all, log_sig, test="Chisq") # insignificant p-val so we use simpler model

# still need to do an interaction effect analysis




# predict outcome variable using optimal model
log_pred <- predict(log_sig, stroke$training, type = "response");
classified_pred <- ifelse(log_pred >= 0.5, 1, 0);
```

## Model Accuracy
```{r accuracy, echo=F}
model_accuracy <- function(model_pred){
  accuracy <- mean(model_pred == stroke$training$stroke)
  return(paste("Accuracy =", round(accuracy, 4)))
}

roc <- function(model_pred){
  roc_pred <- prediction(model_pred, stroke$training$stroke)
  roc_perf <- performance(roc_pred, measure = "tpr", x.measure = "fpr")
  
  auc <- performance(roc_pred, measure = "auc")
  auc <- auc@y.values[[1]]
   
  # Plotting
  plot(roc_perf, main = "ROC CURVE", col = "blue", lwd = 1.5)
  legend(.6, .4, round(auc, 4), title = "AUC", cex = 1)
}

confusion_matrix <- function(model_pred) {
  table(model_pred, stroke$training$stroke)
}


model_accuracy(classified_pred);
# roc(log_pred)
confusion_matrix(classified_pred)
```


# EDA

### Biological Variables
```{r eda-bio, echo=F}
biological_model <- lm(
    stroke ~ gender + age + hypertension + heart_disease + avg_glucose_level + bmi,
    data = stroke$training
);
summary(biological_model);
```
### Lifestyle Variables
```{R eda-life, echo=F}
lifestyle_model <- lm(stroke ~ ever_married + work_type + Residence_type + smoking_status, data = stroke$training)
summary(lifestyle_model);
```

### Interactions
This model includes all significant features from each set, plus targeted interaction effects for lifestyle and socio-economic factors that we hypothesize might have a relationship with health factors.
```{r eda-interaction, echo=F}
interaction_model <- glm(
    stroke ~ 
        hypertension * age + 
        bmi * age + 
        avg_glucose_level * age +
        avg_glucose_level * bmi +
        heart_disease * age +
        smoking_status +
        Residence_type + 
        ever_married,
    data = stroke$training
);
summary(interaction_model);
```

### Restricted Model
```{r eda-restricted, echo=F}
restricted_model <- glm(
    stroke ~ 
        hypertension * age + 
        age * avg_glucose_level,
    data = stroke$training
);
summary(restricted_model);
```

#ROC Curve:
```{r, echo=F}
log_pred <- predict(restricted_model, stroke$training, type = "response")
```


```{r, echo=F}
roc(log_pred)
```
Using Training data to determine Threshold:
```{r, echo=F}
log_pred_2 <- ifelse(log_pred >= 0.05, 1, 0)
model_accuracy(log_pred_2)
confusion_matrix(log_pred_2)
```

Now for Test data:
```{r, echo=F}
model_accuracy_test <- function(model_pred){
  accuracy <- mean(model_pred == stroke$test$stroke)
  return(paste("Accuracy =", round(accuracy, 4)))
}
confusion_matrix_test <- function(model_pred) {
  table(model_pred, stroke$test$stroke)
}
```



```{r, echo=F}
log_pred_test <- predict(restricted_model, stroke$test, type = "response")
log_pred_class_test <- ifelse(log_pred_test >= 0.05, 1, 0)
model_accuracy_test(log_pred_class_test)
confusion_matrix_test(log_pred_class_test)
```

Log Odds and Confidence Interval
```{r final_interpretation, echo=F}
restricted_model <- glm(
    stroke ~ 
        hypertension * age + 
        age * avg_glucose_level,
    data = stroke$training
);
summary(restricted_model);
## Log Odds
exp(coef(summary(restricted_model))[, 1])


## Confidence Interval Plot
install.packages("sjPlot");
library(sjPlot);
plot_model(restricted_model)
```
